#!/usr/bin/env pwsh
# Script d'installation automatique du Widget de Vuln√©rabilit√©s
# Usage: .\install-vulnerability-widget.ps1

Write-Host "üîß Installation du Widget de Vuln√©rabilit√©s dans Admin Dashboard..." -ForegroundColor Cyan

$adminDashboardPath = "c:\STS\mediatech_app\frontend\src\app\pages\admin-dashboard\admin-dashboard.component.ts"

# V√©rifier que le fichier existe
if (-not (Test-Path $adminDashboardPath)) {
    Write-Host "‚ùå Erreur: Fichier admin-dashboard.component.ts non trouv√©!" -ForegroundColor Red
    exit 1
}

Write-Host "‚úÖ Fichier trouv√©: $adminDashboardPath" -ForegroundColor Green

# Lire le contenu
$content = Get-Content $adminDashboardPath -Raw

# V√©rifier si d√©j√† install√©
if ($content -match "VulnerabilityWidgetComponent") {
    Write-Host "‚ö†Ô∏è  Le widget semble d√©j√† install√©!" -ForegroundColor Yellow
    $response = Read-Host "Voulez-vous r√©installer? (o/N)"
    if ($response -ne "o") {
        Write-Host "Installation annul√©e." -ForegroundColor Yellow
        exit 0
    }
}

Write-Host "üìù Modification du fichier..." -ForegroundColor Cyan

# 1. Ajouter l'import en haut du fichier
$importLine = "import { VulnerabilityWidgetComponent } from '../../components/vulnerability-widget/vulnerability-widget.component';"

if ($content -notmatch "VulnerabilityWidgetComponent") {
    # Trouver la ligne apr√®s les autres imports
    $content = $content -replace "(import.*from '@angular/router';)", "`$1`n$importLine"
    Write-Host "  ‚úì Import ajout√©" -ForegroundColor Green
}

# 2. Ajouter dans le tableau imports du @Component
if ($content -match "imports:\s*\[([\s\S]*?)\]") {
    $importsBlock = $matches[1]
    if ($importsBlock -notmatch "VulnerabilityWidgetComponent") {
        $newImportsBlock = $importsBlock.TrimEnd() + ",`n    VulnerabilityWidgetComponent"
        $content = $content -replace "imports:\s*\[$importsBlock\]", "imports: [$newImportsBlock]"
        Write-Host "  ‚úì Component ajout√© aux imports" -ForegroundColor Green
    }
}

# 3. Ajouter le widget dans le template (apr√®s les stats)
$widgetHtml = @"

        <!-- ü¶† SECTION VULN√âRABILIT√âS -->
        <div class="security-section">
          <app-vulnerability-widget></app-vulnerability-widget>
        </div>
"@

# Chercher un bon endroit pour ins√©rer (apr√®s la grille de stats)
if ($content -match "(<div class=`"stats-grid`">[\s\S]*?</div>)") {
    if ($content -notmatch "app-vulnerability-widget") {
        $content = $content -replace "(<div class=`"stats-grid`">[\s\S]*?</div>)", "`$1$widgetHtml"
        Write-Host "  ‚úì Widget HTML ajout√© au template" -ForegroundColor Green
    }
} else {
    Write-Host "  ‚ö†Ô∏è  Impossible de trouver stats-grid, ajout manuel requis" -ForegroundColor Yellow
}

# 4. Ajouter le style CSS pour la section
$sectionStyle = @"

    .security-section {
      margin: 2rem 0;
      grid-column: 1 / -1;
    }
"@

if ($content -notmatch "\.security-section") {
    # Ajouter avant la fermeture du bloc styles
    $content = $content -replace "(\s*`]`s*\))\s*export class AdminDashboardComponent", "$sectionStyle`n  `$1`nexport class AdminDashboardComponent"
    Write-Host "  ‚úì Styles CSS ajout√©s" -ForegroundColor Green
}

# Sauvegarder
try {
    $content | Set-Content $adminDashboardPath -Encoding UTF8
    Write-Host "`n‚úÖ Installation r√©ussie!" -ForegroundColor Green
    Write-Host "`nüìã Prochaines √©tapes:" -ForegroundColor Cyan
    Write-Host "  1. D√©marrez MySQL (port 3306)" -ForegroundColor White
    Write-Host "  2. D√©marrez le backend: cd backend && .\mvnw spring-boot:run" -ForegroundColor White
    Write-Host "  3. Rechargez votre application Angular (Ctrl+C puis npm start)" -ForegroundColor White
    Write-Host "  4. Connectez-vous en tant qu'admin et v√©rifiez le dashboard!" -ForegroundColor White
} catch {
    Write-Host "`n‚ùå Erreur lors de la sauvegarde: $_" -ForegroundColor Red
    exit 1
}
